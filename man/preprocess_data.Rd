% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/preprocess.R
\name{preprocess_data}
\alias{preprocess_data}
\title{Preprocess Loaded Datasets}
\usage{
preprocess_data(
  loaded_data,
  files_path,
  config_filename = "config.yaml",
  log_directory = NULL,
  log_file_prefix = "preprocess_log_",
  dict_suv_target_col = NULL,
  dict_suv_potential_cols = NULL,
  verbose = TRUE
)
}
\arguments{
\item{loaded_data}{List. The \strong{raw} output from \code{load_datasets()}. Expected
to be a named list where each element is a dataset (itself a list
containing data frames like 'data' and 'data_suv_bi').}

\item{files_path}{Character string. Path to the directory provided by the user
containing supporting files: the SUV dictionary (\code{dict_suv.csv}) and the
main configuration file (specified by \code{config_filename}).}

\item{config_filename}{Character string. Name of the YAML configuration
file expected within \code{files_path}. Defaults to "config.yaml".}

\item{log_directory}{Character string or NULL. Path to the \strong{directory} where
timestamped log files should be written. If NULL (default), logging to
file is disabled. The directory will be created if it doesn't exist.}

\item{log_file_prefix}{Character string. Prefix for the generated log filename.
Defaults to "preprocess_log_".}

\item{dict_suv_target_col}{Character string or NULL. Target column name in
\code{dict_suv.csv} containing the \emph{final desired} variable names for \code{data_suv_bi}.
Defaults to the first column name of the loaded \code{dict_suv}.}

\item{dict_suv_potential_cols}{Character vector or NULL. Names of columns in
\code{dict_suv.csv} that contain \emph{potential sets} of variable names to match
against the actual \code{data_suv_bi}. If NULL (default), \strong{all} columns in
\code{dict_suv} are used for matching.}

\item{verbose}{Logical. If TRUE, print some progress messages to console and
enable detailed messages within the log file. Defaults to TRUE. Note: Most
detailed messages go only to the log file when active due to sink settings.}
}
\value{
A list containing:
\describe{
\item{data}{The \strong{processed} list of datasets. Data frames within each
dataset will have \code{data_suv_bi} columns potentially renamed/subsetted
and \emph{all} data frames filtered row-wise based on preprocessing criteria.}
\item{config}{The loaded configuration list.}
\item{validation_report}{A list detailing structural issues found \emph{before}
row filtering (e.g., missing required columns, issues during SUV
renaming/subsetting, discarded columns).}
\item{preprocessing_log}{A list detailing the number of unique IDs and rows
removed during the preprocessing filter steps (min entries, inclusion
criteria) for each dataset.}
\item{log_file}{The full path to the generated detailed text log file,
or NULL if logging was disabled.}
}
}
\description{
Loads configuration and dictionaries, checks data structures, prepares SUV data
(renaming or subsetting columns based on dictionary match), filters datasets
based on minimum entries per ID and group-specific inclusion criteria, and
logs operations, warnings, and filtering counts.
}
\details{
This function performs the entire check, preparation, and preprocessing workflow:
\enumerate{
\item \strong{Logging Setup:} Creates a timestamped log file in \code{log_directory} if specified.
Uses \code{sink(..., split=FALSE)} for messages. Warnings are captured via
\code{withCallingHandlers}, logged, and also displayed on the console.
\item \strong{Config/Dict Loading:} Loads YAML config and \code{dict_suv.csv} from \code{files_path}.
Validates essential configuration.
\item \strong{Dataset Iteration:} Processes each dataset found in \code{loaded_data}.
\item \strong{Initial Checks & SUV Prep (Per Dataset):}
\itemize{
\item Verifies \code{data} columns against \code{required_data_columns} in config.
\item Finds the column in \code{dict_suv} with the most matching columns vs \code{data_suv_bi}.
\item Checks for missing columns relative to the best match.
\item \strong{Renames OR Subsets} columns in \code{data_suv_bi} based on best match vs target.
\item Logs findings and actions in \code{validation_report} and the text log.
}
\item \strong{Preprocessing Filters (Per Dataset):}
\itemize{
\item Reads preprocessing settings (\code{min_entries_per_id}, etc.) and
\code{inclusion_criteria} from config.
\item Filters individuals based on minimum entries.
\item Filters individuals based on group-specific inclusion criteria (AGE, MMSE, etc.).
Handles missing criteria columns with warnings.
\item Determines the final set of rows to keep based on individuals passing filters.
\item \strong{Applies row filtering} to \emph{all} data frames within the dataset based
on the indices determined from the criteria source file (e.g., 'data'),
ensuring row correspondence. Issues warnings if row counts mismatch.
\item Logs counts of removed IDs/rows at each step in \code{preprocessing_log} and the text log.
}
}
}
